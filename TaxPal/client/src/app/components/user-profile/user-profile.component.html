<div class="profile-container" [ngClass]="{ dark: isDarkMode }">
  <!-- User Profile Circle Avatar - Top right corner -->
  <div class="hero-user-profile">
    <button type="button" class="profile-avatar" (click)="toggleProfileMenu()">
      <span>{{ userInitial }}</span>
    </button>

    <div class="profile-menu-dropdown" *ngIf="showProfileMenu">
      <div class="profile-section">
        <div class="profile-info centered-profile">
          <h3>{{ userName || 'User' }}</h3>
          <p>{{ userEmail }}</p>
        </div>
      </div>
      <div class="profile-menu-divider"></div>
      <div class="profile-menu-items">
        <a [routerLink]="['/user-profile']" class="profile-menu-item" (click)="closeProfileMenu()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="3" y="3" width="7" height="9" />
            <rect x="14" y="3" width="7" height="5" />
            <rect x="14" y="12" width="7" height="9" />
            <rect x="3" y="16" width="7" height="5" />
          </svg>
          <span>Dashboard</span>
        </a>
        <a
          [routerLink]="['/profile-settings']"
          class="profile-menu-item"
          (click)="closeProfileMenu()"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="3"></circle>
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
            ></path>
          </svg>
          <span>Profile Settings</span>
        </a>
        <div class="profile-menu-divider"></div>
        <button type="button" class="profile-menu-item logout-item" (click)="logout()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>

  <div class="profile-content">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <h1 class="page-title">Welcome back, {{ userName || 'User' }}</h1>
      <p class="subtitle">Here's an overview of your tax and financial status</p>
    </div>

    <!-- Financial Metrics Cards -->
    <div class="metrics-row">
      <div class="metric-card">
        <div class="metric-header">
          <h3>Monthly Income</h3>
          <div class="metric-trend">
            <!-- Modified SVG for income - always shows upward trend in green -->
            <svg
              class="trend-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="color: #10b981"
            >
              <path d="M23 6l-9.5 9.5-5-5L1 18" />
              <path d="M17 6h6v6" />
            </svg>
            <!-- Changed to always use positive class for income changes -->
            <span class="metric-change positive">
              {{ monthlyIncomeChange >= 0 ? '+' : '' }}{{ monthlyIncomeChange | number : '1.1-1' }}%
            </span>
          </div>
        </div>
        <div class="metric-value">${{ currentMonthIncome | number : '1.0-0' }}</div>
        <div class="metric-subtitle">from last month</div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>Monthly Expenses</h3>
          <div class="metric-trend">
            <!-- Modified SVG for expenses - always shows downward trend in red -->
            <svg
              class="trend-icon"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="color: #ef4444"
            >
              <path d="M23 18l-9.5-9.5-5 5L1 6" />
              <path d="M17 18h6v-6" />
            </svg>
            <span
              class="metric-change"
              [class.positive]="monthlyExpenseChange < 0"
              [class.negative]="monthlyExpenseChange >= 0"
            >
              {{ monthlyExpenseChange >= 0 ? '+' : ''
              }}{{ monthlyExpenseChange | number : '1.1-1' }}%
            </span>
          </div>
        </div>
        <div class="metric-value">${{ currentMonthExpense | number : '1.0-0' }}</div>
        <div class="metric-subtitle">from last month</div>
      </div>

      <!-- Replace Estimated Tax Due with Total Balance -->
      <div class="metric-card">
        <div class="metric-header">
          <h3>Estimated Tax Due</h3>
          <div class="metric-trend">
            <svg
              class="trend-icon"
              [ngClass]="{ up: balanceChange >= 0, down: balanceChange < 0 }"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                [attr.d]="
                  balanceChange >= 0 ? 'M23 6l-9.5 9.5-5-5L1 18' : 'M23 18l-9.5-9.5-5 5L1 6'
                "
              />
              <path [attr.d]="balanceChange >= 0 ? 'M17 6h6v6' : 'M17 18h6v-6'" />
            </svg>
            <span
              class="metric-change"
              [class.positive]="balanceChange >= 0"
              [class.negative]="balanceChange < 0"
            >
              {{ balanceChange >= 0 ? '+' : '' }}{{ balanceChange | number : '1.1-1' }}%
            </span>
          </div>
        </div>
        <div class="metric-value">${{ totalBalance | number : '1.0-0' }}</div>
        <div class="metric-subtitle">total balance</div>
      </div>

      <!-- Savings Rate Card -->
      <div class="metric-card">
        <div class="metric-header">
          <h3>Savings Rate</h3>
          <div class="metric-trend">
            <svg
              class="trend-icon"
              [ngClass]="{ up: savingsRateChange >= 0, down: savingsRateChange < 0 }"
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                [attr.d]="
                  savingsRateChange >= 0 ? 'M23 6l-9.5 9.5-5-5L1 18' : 'M23 18l-9.5-9.5-5 5L1 6'
                "
              />
              <path [attr.d]="savingsRateChange >= 0 ? 'M17 6h6v6' : 'M17 18h6v-6'" />
            </svg>
            <span
              class="metric-change"
              [class.positive]="savingsRateChange >= 0"
              [class.negative]="savingsRateChange < 0"
            >
              {{ savingsRateChange >= 0 ? '+' : '' }}{{ savingsRateChange | number : '1.1-1' }}%
            </span>
          </div>
        </div>
        <div class="metric-value">{{ savingsRate | number : '1.1-1' }}%</div>
        <div class="metric-subtitle">of monthly income</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions top-actions">
      <div class="action-buttons">
        <button class="action-btn income-btn" (click)="showAddIncomeModal()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10" />
            <line x="12" y="8" x2="12" y2="16" />
            <line x="8" y="12" x2="16" y2="12" />
          </svg>
          Add Income
        </button>
        <button class="action-btn expense-btn" (click)="showAddExpenseModal()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10" />
            <line x="8" y="12" x2="16" y2="12" />
          </svg>
          Add Expense
        </button>
      </div>
    </div>

    <!-- Total Balance and Recent Transactions Row -->
    <div class="balance-transactions-row">
      <!-- Recent Transactions -->
      <div class="dashboard-section">
        <div class="section-header">
          <h3>Recent Transactions</h3>
        </div>
        <div class="transactions-list">
          <ng-container *ngIf="recentTransactions.length > 0; else noTransactions">
            <div *ngFor="let tx of recentTransactions" class="transaction-item" [ngClass]="tx.type">
              <div class="transaction-info">
                <h4>{{ tx.title }}</h4>
                <div class="transaction-meta">
                  <span class="date">{{ tx.date | date : 'mediumDate' }}</span>
                  <span class="separator">•</span>
                  <span class="category">{{
                    tx.category || (tx.type === 'income' ? 'Income' : 'Expense')
                  }}</span>
                </div>
              </div>
              <div
                class="transaction-amount"
                [ngClass]="tx.type === 'income' ? 'positive' : 'negative'"
              >
                {{ tx.type === 'income' ? '+' : '-'
                }}{{ tx.amount | currency : 'USD' : 'symbol' : '1.2-2' }}
              </div>
            </div>
          </ng-container>
          <ng-template #noTransactions>
            <div class="no-income-msg">No recent transactions.</div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Dashboard Grid - Expense Breakdown (left) and Income vs Expense Chart (right) -->
    <div class="dashboard-grid two-col-grid">
      <!-- Expense Breakdown as Pie Chart (left) -->
      <div class="dashboard-section expense-breakdown-section">
        <div class="section-header">
          <h3>Expense Breakdown</h3>
        </div>
        <div class="expense-pie-container">
          <div class="chart-container">
            <canvas id="expenseChart"></canvas>
          </div>
          <div *ngIf="expenseList.length === 0" class="no-expense-msg">
            No expenses to display.
          </div>
        </div>
      </div>

      <!-- Income vs Expenses Chart (right) -->
      <div class="dashboard-section income-expense-section">
        <div class="card finance-chart-card">
          <div class="card-header">
            <h2 class="chart-title">Monthly Income & Expenses</h2>
          </div>
          <div class="card-body" style="padding-bottom: 60px">
            <div *ngIf="!hasFinancialData()" class="no-data-message">
              <p>No financial data available yet. Add income and expenses to see your financial chart.</p>
            </div>
            <div *ngIf="hasFinancialData()" class="finance-chart">
              <div class="chart-container">
                <div class="chart-y-axis">
                  <div class="axis-value" *ngFor="let value of yAxisValues">
                    {{ formatCurrency(value) }}
                  </div>
                </div>

                <div class="chart-bars">
                  <div class="month-column" *ngFor="let month of getDisplayMonths()">
                    <div class="bar-group">
                      <div
                        class="bar income-bar"
                        [style.height.%]="getBarHeight(month.income)"
                        [attr.data-label]="'Income'"
                        [attr.data-value]="formatCurrency(month.income)"
                        [attr.data-month]="month.month"
                        (mouseenter)="showTooltip($event)"
                        (mouseleave)="hideTooltip()"
                      ></div>
                      <div
                        class="bar expense-bar"
                        [style.height.%]="getBarHeight(month.expense)"
                        [attr.data-label]="'Expense'"
                        [attr.data-value]="formatCurrency(month.expense)"
                        [attr.data-month]="month.month"
                        (mouseenter)="showTooltip($event)"
                        (mouseleave)="hideTooltip()"
                      ></div>
                    </div>
                    <div class="month-label">{{ month.month }}</div>
                  </div>
                </div>

                <div class="chart-legend">
                  <div class="legend-item">
                    <div class="legend-color income-color"></div>
                    <div class="legend-label">Income</div>
                  </div>
                  <div class="legend-item">
                    <div class="legend-color expense-color"></div>
                    <div class="legend-label">Expenses</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Add tooltip element -->
        <div id="chart-tooltip" class="chart-tooltip" [ngStyle]="tooltipStyle">
          <div class="tooltip-month" *ngIf="tooltipData.month">{{ tooltipData.month }}</div>
          <div class="tooltip-value" *ngIf="tooltipData.label">
            <strong>{{ tooltipData.label }}:</strong> {{ tooltipData.value }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Income Modal -->
  <div class="modal-overlay" *ngIf="isAddIncomeModalVisible" (click)="hideAddIncomeModal($event)">
    <div class="modal-container">
      <div class="modal-header">
        <h2>Add New Income</h2>
        <p class="modal-subtitle">Track your earnings to better manage your finances</p>
      </div>
      <div class="modal-body">
        <div *ngIf="incomeErrorMsg" class="form-error">{{ incomeErrorMsg }}</div>
        <div *ngIf="incomeSuccessMsg" class="form-success">{{ incomeSuccessMsg }}</div>
        <div class="form-group">
          <label for="income-title">Title</label>
          <input
            type="text"
            id="income-title"
            placeholder="Freelance project"
            [(ngModel)]="incomeForm.title"
          />
        </div>
        <div class="form-group">
          <label for="income-amount">Amount</label>
          <div class="amount-input">
            <span class="currency-symbol">$</span>
            <input
              type="number"
              id="income-amount"
              placeholder="0.00"
              step="0.01"
              [(ngModel)]="incomeForm.amount"
            />
          </div>
        </div>
        <div class="form-group">
          <label for="income-category">Category</label>
          <select id="income-category" [(ngModel)]="incomeForm.category">
            <option value="" disabled selected>Select category</option>
            <option value="freelance">Freelance Work</option>
            <option value="consulting">Consulting</option>
            <option value="contract">Contract Work</option>
            <option value="services">Services</option>
            <option value="sale">Product Sale</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="income-date">Date</label>
            <input type="date" id="income-date" [(ngModel)]="incomeForm.date" />
          </div>
        </div>
        <div class="form-group">
          <label for="income-notes">Notes</label>
          <textarea
            id="income-notes"
            placeholder="Add any additional details..."
            [(ngModel)]="incomeForm.notes"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="hideAddIncomeModal()">Cancel</button>
        <button class="btn-submit" (click)="submitIncome()" [disabled]="incomeLoading">
          <span *ngIf="incomeLoading" class="loader"></span>
          <span *ngIf="!incomeLoading">Add Income</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Add Expense Modal -->
  <div class="modal-overlay" *ngIf="isAddExpenseModalVisible" (click)="hideAddExpenseModal($event)">
    <div class="modal-container">
      <div class="modal-header">
        <h2>Add New Expense</h2>
        <p class="modal-subtitle">Track your expenses to better manage your finances</p>
      </div>
      <div class="modal-body">
        <div *ngIf="expenseErrorMsg" class="form-error">{{ expenseErrorMsg }}</div>
        <div *ngIf="expenseSuccessMsg" class="form-success">{{ expenseSuccessMsg }}</div>
        <div class="form-group">
          <label for="expense-title">Title</label>
          <input
            type="text"
            id="expense-title"
            placeholder="Office supplies"
            [(ngModel)]="expenseForm.title"
          />
        </div>
        <div class="form-group">
          <label for="expense-amount">Amount</label>
          <div class="amount-input">
            <span class="currency-symbol">$</span>
            <input
              type="number"
              id="expense-amount"
              placeholder="0.00"
              step="0.01"
              [(ngModel)]="expenseForm.amount"
            />
          </div>
        </div>
        <div class="form-group">
          <label for="expense-category">Category</label>
          <select id="expense-category" [(ngModel)]="expenseForm.category">
            <option value="" disabled selected>Select category</option>
            <option value="rent">Rent/Mortgage</option>
            <option value="utilities">Utilities</option>
            <option value="business">Business Expenses</option>
            <option value="food">Food</option>
            <option value="transportation">Transportation</option>
            <option value="insurance">Insurance</option>
            <option value="marketing">Marketing</option>
            <option value="office">Office Supplies</option>
            <option value="software">Software & Subscriptions</option>
            <option value="travel">Travel</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="expense-date">Date</label>
            <input type="date" id="expense-date" [(ngModel)]="expenseForm.date" />
          </div>
          <div class="form-group">
            <label for="expense-tax-deductible">Tax Deductible</label>
            <select id="expense-tax-deductible" [(ngModel)]="expenseForm.taxDeductible">
              <option value="" disabled selected>Select</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
              <option value="partial">Partially</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="expense-notes">Notes</label>
          <textarea
            id="expense-notes"
            placeholder="Add any additional details..."
            [(ngModel)]="expenseForm.notes"
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="hideAddExpenseModal()">Cancel</button>
        <button
          class="btn-submit expense-submit"
          (click)="submitExpense()"
          [disabled]="expenseLoading"
        >
          <span *ngIf="expenseLoading" class="loader"></span>
          <span *ngIf="!expenseLoading">Add Expense</span>
        </button>
      </div>
    </div>
  </div>
